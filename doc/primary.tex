
\chapter{Primary Unit}

This machine talks directly to the PiC through its PCI interface (and
through the DMA card?).  It is responsible for farming out the
digitized data to multiple secondary units.

\section{Data Flow Control Software}

The Data Flow Control software running on the Primary and Secondary
Units is divided into three sections:
\begin{itemize}
\item Direct Memory Access (DMA)
\item File Input/Output (FIO)
\item Network Input/Output (NIO)
\end{itemize}

\subsection{Direct Memory Access (DMA)}

Direct Memory Access (DMA) transfer of digitized data from the PiC to
Primary Unit RAM occurs via a DMA card that is commercially available
from Engineering Design Team (EDT).  The DMA control software will:

\begin{enumerate}

\item allocate a number of fixed memory buffers of a size and number
to be determined during the testing stage;

\item send start and stop instructions to the PiC via the PCI/DMA interface;

\item copy filled memory buffers to the Data Block; and

\item monitor the number of buffers filled and copied, ensuring that
no data overflow occurs.

\end{enumerate}

\noindent
The DMA buffers will be separate from the Data Block buffers and
accessed only by the DMA card driver and a single process.  Once
started, DMA transfer will continue uninterrupted until a stop flag is
raised or an overflow occurs.

The Data Block will be allocated as a shared memory resource to which
only the DMA control process may write.  The Data Block will be
readable to any number of data monitoring processes, such as the
\emph{bandpass monitor}.  Only one process will be given the authority
to flag Data Block buffers as finished.

\subsection{File Input/Output (FIO)}

This process will read buffers from the Data Block, write them to
disk, and flag the written buffers as finished.  It can be run on
either Primary or Secondary Units, depending on the mode of operation.

\subsection{Network Input/Output (NIO)}

The software for network I/O will run on both Primary and Secondary
Units.  The protocol for the network communications will be a simple,
custom-built design on top of internet sockets.  This may change in
the future to some sort of grid-based protocol.

Header information (including all available observation information as
well as offset byte counts) will be sent with each block of data sent
from the Primary to Secondary Units.  The process running on each
Secondary unit will receive the data and write it to the Data Block in
its own shared memory.

The Secondary NIO software has the responsibility to monitor the
shared memory and ensure that there is sufficient space to hold
incoming data packets.  If there is insufficient space, the Primary
NIO should cease transfer to the current Secondary Unit and begin
transferring data to the next in the ring.
